<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DG-AC</title>
  </head>
  <body>
    mapa
    <canvas width="400" height="300"></canvas>
    map2
    <canvas width="400" height="300"></canvas>
    <script type="module">
      const W = 400;
      const H = 300;
      const S = 10;
      const HS = H / S;
      const WS = W / S;
      const COLORS = ["tan", "chocolate", "brown"];
      console.log(S, W, H, WS, HS);
      var steps = 0;
      var map = [];
      var map2 = [];
      var te = 0;
      var dt = 0;
      map = initMap(HS, WS, 1);
      map2 = initMap(HS, WS, 0);
      //var req = requestAnimationFrame(fullstep);

      var canvas = document.querySelectorAll("canvas")[0];
      var canvas2 = document.querySelectorAll("canvas")[1];
      canvas.width = W;
      canvas.height = H;
      canvas2.width = W;
      canvas2.height = H;
      var ctx = canvas.getContext("2d");
      var ctx2 = canvas2.getContext("2d");
      //setArea(map, 2, 2, 3, 3, 0);
      //setArea(map, 4, 5, 3, 3, 0);
      //setArea(map, 12, 12, 3, 3, 0);
      //automastep();
      //toggleMaps();

      drawMap(map);
      drawMap(map2, 1);

      //setArea(map, 12,3,3,3,0);
      //automastep();
      //toggleMaps();

      drawMap(map);
      drawMap(map2, 1);

      canvas.addEventListener("click", function(e) {
        let tC = Math.floor(e.offsetX / S);
        let tL = Math.floor(e.offsetY / S);

        setArea(map, tC, tL, 3, 3, 0);
        automastep();
        //toggleMaps()
        drawMap(map);
        drawMap(map2, 1);
        //steps= 1;
        //requestAnimationFrame(fullstep)
      });

      function setArea(mapx, x, y, w, h, v) {
        const mL = Math.max(y, 0);
        const ML = Math.min(y + h, mapx.length);
        const mC = Math.max(x, 0);
        const MC = Math.min(x + w, mapx[0].length);
        for (let l = mL; l < ML; l++) {
          for (let c = mC; c < MC; c++) {
            mapx[l][c] = v;
          }
        }
      }

      function fullstep(t) {
        dt = (t - te) / 1000;
        automastep();
        toggleMaps();
        drawMap(map);
        te = t;
        if (steps-- > 0) {
          req = requestAnimationFrame(fullstep);
        }
      }
      function drawMap(mapx, cv) {
        for (let l = 0; l < mapx.length; l++) {
          for (let c = 0; c < mapx[0].length; c++) {
            if (!cv) {
              ctx.fillStyle = COLORS[mapx[l][c]];
              ctx.fillRect(c * S, l * S, S, S);
            } else {
              ctx2.fillStyle = COLORS[mapx[l][c]];
              ctx2.fillRect(c * S, l * S, S, S);
            }
          }
        }
      }
      function countAd(mapx, y, x, tp) {
        let total = 0;
        const mL = Math.max(y - 1, 0);
        const ML = Math.min(y + 2, mapx.length);
        const mC = Math.max(x - 1, 0);
        const MC = Math.min(x + 2, mapx[0].length);

        for (let l = mL; l < ML; l++) {
          for (let c = mC; c < MC; c++) {
            if (mapx[l][c] === tp && (x !== c && y !== l)) {
              total++;
            }
          }
        }
        return total;
      }

      function toggleMaps() {
        map = JSON.parse(JSON.stringify(map2));
      }

      function automastep() {
        for (let l = 0; l < map2.length; l++) {
          for (let c = 0; c < map2[0].length; c++) {
            switch (map[l][c]) {
              case 1:
                if (countAd(map, l, c, 0) > 0) {
                  map2[l][c] = 2;
                } else {
                  map2[l][c] = 1;
                }

                break;

              default:
                map2[l][c] = map[l][c];
                break;
            }
            //   if(countAd(sou,l,c,1)>=5){
            //     tar[l][c] = 0;
            // } //else if (countAd(sou, l, c, 0)>=1) {
            // tar[l][c] = 2;
            //}//else
            // if (tar[l][c]==1 && countAd(sou, l, c, 0) >= 1) {
            //    tar[l][c] = 2;
            // }
          }
        }
      }

      function initMap(L, C, v) {
        let mapx = [];
        for (let l = 0; l < L; l++) {
          mapx[l] = [];
          for (let c = 0; c < C; c++) {
            mapx[l][c] = v;
          }
        }
        return mapx;
      }
    </script>
  </body>
</html>
